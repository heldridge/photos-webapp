---
- hosts: web
  become: yes

  tasks:
    - name: get timestamp from the system
      shell: "date --utc +%F_%H-%M-%S-%Z"
      register: timestamp

    - name: clone repository
      become_user: django
      git:
        name: "git@github.com:heldridge/photos-webapp.git"
        dest: "/home/django/checkouts/{{ timestamp.stdout }}"
    
    - name: install requirements requirements
      pip:
        name:
          - virtualenv
          - setuptools

    - name: install requirements
      become_user: django
      pip:
        virtualenv: "/home/django/checkouts/{{ timestamp.stdout }}/django/venv"
        virtualenv_command: "/usr/bin/python3 -m virtualenv"
        virtualenv_python: python3.8
        requirements: "/home/django/checkouts/{{ timestamp.stdout }}/requirements.txt"

    - name: create deployment symlink
      file:
        state: link
        path: /home/django/current_deployment
        src: /home/django/checkouts/{{ timestamp.stdout }}/django
        follow: false

    - name: upload gunicorn service config
      copy:
        src: gunicorn.service
        dest: /etc/systemd/system/gunicorn.service
        owner: root
        group: root
        mode: '0644'

    - name: start gunicorn service
      systemd:
        state: restarted
        enabled: yes
        name: gunicorn

    - name: upload nginx config
      copy: 
        src: photos
        dest: /etc/nginx/sites-available/photos
        owner: root
        group: root
        mode: '0644'
    
    - name: symlink site to sites-enabled
      file:
        state: link
        path: /etc/nginx/sites-enabled/photos
        src: /etc/nginx/sites-available/photos

    - name: restart nginx
      systemd:
        state: restarted
        name: nginx

    - name: open nginx to world
      ufw:
        rule: allow
        name: "Nginx Full"
