{% extends 'base.html.j2' %}

{% load static %}

{% block content %}
<div class="search-page flex justify-center flex-wrap md:flex-no-wrap mt-5 mb-5">
    <div class="search-sidebar md:w-1/5 max-w-xl ml-3 mr-3 md:mr-0">
        <div class="tags-bar border-2 border-default rounded px-5 flex flex-col py-3">

            {% if search_uploaded_by %}
            <h1 class="text-2xl font-semibold pb-3 pt-1 opacity-high-emphasis flex items-center">
                {{ search_uploaded_by_display_name }}'s uploads
                <a href="{% url 'search' %}?{% for name, value in main_qsp.items %}{% if name != 'uploaded_by' and value %}&{{ name }}={{ value }}{% endif %}{% endfor %}" class="ml-3">
                    <i class="fas fa-times pr-1 opacity-medium-emphasis hover:opacity-high-emphasis hover:text-tag-item-hover"></i>
                </a>
            </h1>
            {% endif %}

            <div class="flex flex-col align">
                <div class="flex border border-default justify-between bg-surface-1 w-4/5 rounded overflow-hidden border-color-transition disable-transition-on-theme-change" id="addTagsInputContainer">
                    <div class="my-2 pl-2">
                        <input 
                            type="text"
                            class="appearance-none w-full pr-2 bg-surface-1" 
                            placeholder="Add Tags..." 
                            id="addTagsInput" 
                            oninput="addTagsInputUpdated()"
                            onkeyup="addTagsInputOnKeyUp(event)"">
                    </div>
                    <a href="{% url 'search' %}?{% for name, value in main_qsp.items %}{% if name != 'tags' and value %}&{{ name }}={{ value }}{% endif %}{% endfor %}&tags={{ main_qsp.tags }}" class="bg-button-disabled pointer-events-none px-3 py-2 disable-transition-on-theme-change" id="addTagsButton">
                        <i class="fas fa-plus opacity-disabled" id="addTagsIcon"></i>
                    </a>
                </div>
                <p class="pt-1 text-error hidden" id="addTagsErrorMessage">  </p>
            </div>
            
            
            <h1 class="text-2xl font-semibold pb-3 pt-1 opacity-high-emphasis">
                Searched Tags
            </h1>

            {% if searched_tags_data %}
                <div class="flex flex-row flex-wrap w-4/5">
                {% for tag_data in searched_tags_data %}
                    <div class="tag bg-tag text-tag rounded py-1 px-2 text-xs md:text-sm mr-2 font-medium mb-2">
                        <a href="{% url 'search' %}?tags={{ tag_data.query_if_removed }}{% for name, value in main_qsp.items %}{% if name != 'tags' and value %}&{{ name }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-times pr-1 opacity-medium-emphasis hover:opacity-high-emphasis hover:text-tag-item-hover"></i>
                        </a>
                        
                        <span class="opacity-medium-emphasis">{{ tag_data.tag }}</span>
                    </div>
                {% endfor %}
                </div>
            {% endif %}

            {% if user.is_authenticated %}
            <div class="flex mt-4 items-center mb-4">
                <h1 class="text-xl font-semibold opacity-high-emphasis mr-4">
                    Favorites Only
                </h1>

                <input type="checkbox" {% if favorites %}checked="checked"{% endif %}class="text-2xl rounded search-checkbox" onclick=updateFavoritesSearch(this)>
            </div>
            {% endif %}

            <button class="flex justify-center rounded border-2 w-40 sort-order-container relative" onclick="toggleSortOrderVisible(this)" id="order-dropdown">
                <h1 class="text-xl">
                    <span class="">
                        {% if main_qsp.order == 'most_favorites' %}
                            Most Favorites
                        {% else %}
                            Most Recent
                        {% endif %}
                    </span>
                    <i class="fas fa-caret-down"></i>
                </h1>

                <div class="hidden absolute w-40 rounded sort-order-box flex flex-col bg-surface-4 shadow-lg py-4">
                    <span><a href="{% url 'search' %}?order=most_recent{% for name, value in main_qsp.items %}{% if name != 'order' and value %}&{{ name }}={{ value }}{% endif %}{% endfor %}" class="opacity-medium-emphasis hover:opacity-high-emphasis font-normal hover:font-medium">Most Recent</a></span>
                    <span><a href="{% url 'search' %}?order=most_favorites{% for name, value in main_qsp.items %}{% if name != 'order' and value %}&{{ name }}={{ value }}{% endif %}{% endfor %}" class="opacity-medium-emphasis hover:opacity-high-emphasis font-normal hover:font-medium">Most Favorites</a></span>
                </div>
            </button>
            
        </div>

        <div class="return-to-first-page-button">
        </div>
    </div>
    
    <div class="w-4/5 max-w-7xl">
        {% if pictures|length == 0 %}
        <div class="flex justify-center">
            <p class='text-2xl md:text-3xl opacity-medium-emphasis ml-4 mt-10 md:mt-20'>No pictures match the given criteria, try a different seach</p>
        </div>
        {% endif %}

        <ul class="flex flex-wrap justify-center" id="cardsHolder">
            {% include "partials/_images_grid.html.j2" with pictures=pictures %}
        </ul>

        <div class="flex justify-between my-2 text-lg">

            {% if pictures|first and render_previous_button %}
            {% with first_picture=pictures|first %}
            <a 
                href="{% url 'search' %}?before={{ first_picture.public_id }}{% for name, value in main_qsp.items %}{% if value %}&{{ name }}={{ value }}{% endif %}{% endfor %}"                id="previousButton" 
                class="rounded py-2 pl-4 pr-3 bg-basic hover:bg-basic-hover text-black"
            >
                <i class="fas fa-arrow-left pr-2"></i>
                Previous
            </a>
            {% endwith %}
            {% else %}
            <div id="previousButton">
            
            </div>
            {% endif %} 
            

            {% if pictures|last and render_next_button %}
            {% with last_picture=pictures|last %}
            <a 
                href="{% url 'search' %}?after={{ last_picture.public_id }}{% for name, value in main_qsp.items %}{% if value %}&{{ name }}={{ value }}{% endif %}{% endfor %}"  
                id="nextButton" 
                class="rounded py-2 pl-4 pr-3 bg-basic hover:bg-basic-hover text-black"
            >
                Next
                <i class="fas fa-arrow-right pl-2"></i>
            </a>
            {% endwith %}
            {% endif %}                
        </div>
    </div>
</div>
<script type="text/javascript">

    let searchedTagsOutside = "{{ tags }}";
    let maxTagLengthOutside = {{ max_tag_length }};
    let minTagLengthOutside = {{ min_tag_length }};
    let validTagRegexOutside = "{{ valid_tag_regex }}";
    let baseFavoritesQueryOutside = "{% for name, value in main_qsp.items %}{% if name != 'favorites' and value %}&{{ name }}={{ value }}{% endif %}{% endfor %}"

</script>
<script type="text/javascript" src="{% static 'js/search.js' %}"></script>
{% endblock %}